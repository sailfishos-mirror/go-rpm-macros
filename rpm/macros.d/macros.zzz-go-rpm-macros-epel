# Copyright © 2015-2019 Jan Chaloupka <jchaloup@redhat.com>,
#                       Nicolas Mailhot <nim@fedoraproject.org>
# Copyright © 2022      Maxwell G <gotmax@e.email>
#
# SPDX-License-Identifier: GPL-3.0-or-later

# Sets environment variables suitable for a Go source archive. Optional arguments:
# -z <number>         read the zth block of definitions, for example
#                     %{goipath<number>}, %{commit<number>}…
#                     derived from the import path value if not specified
# -i <go import path> use the specified import path value instead of the one
#                     found in %{goipath<number>}
# -v                  be verbose
# -V <version>        Should only be specified when creating subpackages with
#                     distinct versions
#                     default: %{version}.%{release}
# -T <tag>            default: %{tag<number>}
# -C <commit>         default: %{commit<number>}
# -B <branch>         default: %{branch<number>}
%goenv(z:i:vV:T:C:B:) %{lua:
local       go =  require "fedora.rpm.go_epel"
local   suffix =  rpm.expand("%{?-z*}")
local  goipath =  rpm.expand("%{?-i*}")
local  verbose = (rpm.expand("%{-v}") ~= "")
local    margs = { version = "V", tag = "T", commit = "C", branch = "B", }
local  mvalues = {}
for m,_ in pairs(margs) do
  local v =  rpm.expand("%{?-" ..  margs[m] .. "*}")
  if (v ~= "") then mvalues[m] = v end
end
go.env(suffix, goipath, verbose, mvalues)
}


# Perform the %install tasks of a golang-*-devel subpackage. Arguments:
# -z <number>         read the zth block of definitions, for example
#                     %{goipaths<number>}
# -a                  process all blocks in one go, instead of using separate
#                     -z calls
# -v                  be verbose
%godevelinstall(z:av) %{lua:
local         go =  require "fedora.rpm.go_epel"
local     suffix =  rpm.expand("%{-z*}")
local processall = (rpm.expand("%{-a}") ~= "") and (rpm.expand("%{-z}") == "")
local    verbose = (rpm.expand("%{-v}") ~= "")
go.install("devel", suffix, processall, verbose)
}

# Perform the %install tasks of a compat-golang-*-devel subpackage. Arguments:
# -z <number>         read the zth block of definitions, for example
#                     %{goaltipaths<number>}
# -a                  process all blocks in one go, instead of using separate
#                     -z calls
# -v                  be verbose
%goaltinstall(z:av) %{lua:
local         go =  require "fedora.rpm.go_epel"
local     suffix =  rpm.expand("%{-z*}")
local processall = (rpm.expand("%{-a}") ~= "") and (rpm.expand("%{-z}") == "")
local    verbose = (rpm.expand("%{-v}") ~= "")
go.install("alt", suffix, processall, verbose)
}


# EPEL 9-only macros

# This is the directory where RHEL 9 bundles golist.
%_golist_dir      %{_libexecdir}/go-rpm-macros

# Workaround for https://bugzilla.redhat.com/show_bug.cgi?id=2098400
# The modified golist in RHEL has a different CLI interface, so we only add
# the extra arguments when that is used.
%goinstallflags %{godefaultflags} -e .proto -e .s -e .md
